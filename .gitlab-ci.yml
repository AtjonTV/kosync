image: golang:1.25-alpine3.23

stages:
  - validate
  - build

bearer:
  stage: validate
  image:
    name: bearer/bearer:1.51.1
    entrypoint: [""]
  allow_failure: true # Allow failure so other stages also run, but a "high" severity is still shown in the pipeline overview.
  script: bearer scan . --format html --output bearer-report.html --fail-on-severity high
  artifacts:
    when: always
    paths:
      - bearer-report.html

wwhrd:
  stage: validate
  allow_failure: true # Allow failure so other stages also run, but issues are still shown in the pipeline overview.
  before_script:
    - go install github.com/frapposelli/wwhrd@9ccc2ff
    - go mod vendor
  script:
    - wwhrd check

staticcheck:
  stage: validate
  allow_failure: true # Allow failure so other stages also run, but issues are still shown in the pipeline overview.
  before_script:
    - go install honnef.co/go/tools/cmd/staticcheck@2025.1.1
  script:
    - staticcheck ./...

sonarqube:
  stage: validate
  image:
    name: sonarsource/sonar-scanner-cli:12.0.0.3214_8.0.1
    entrypoint: [""]
  allow_failure: true
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - npm install -g bun@1.3.5
    - bun install --cwd ./webui
    - sonar-scanner -Dsonar.host.url="${SONAR_HOST_URL}"

compile:
  stage: build
  script:
    - go build -tags netgo -o kosync.exe kosync.go
  artifacts:
    paths:
      - kosync.exe
